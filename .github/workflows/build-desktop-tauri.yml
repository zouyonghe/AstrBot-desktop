name: Build Desktop Tauri

on:
  workflow_dispatch:
    inputs:
      source_git_url:
        description: AstrBot source git URL
        required: false
        default: https://github.com/AstrBotDevs/AstrBot.git
      source_git_ref:
        description: AstrBot source git ref (branch/tag/sha)
        required: false
        default: master
  push:
    branches:
      - main
      - master
    paths:
      - 'scripts/**'
      - 'src-tauri/**'
      - 'ui/**'
      - 'resources/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/build-desktop-tauri.yml'

permissions:
  contents: read

env:
  ASTRBOT_SOURCE_GIT_URL: ${{ vars.ASTRBOT_SOURCE_GIT_URL || 'https://github.com/AstrBotDevs/AstrBot.git' }}
  ASTRBOT_SOURCE_GIT_REF: ${{ vars.ASTRBOT_SOURCE_GIT_REF || 'master' }}

jobs:
  build:
    name: ${{ matrix.os_name }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os_name: linux
            arch: amd64
            runner: ubuntu-22.04
          - os_name: linux
            arch: arm64
            runner: ubuntu-24.04-arm
          - os_name: macos
            arch: amd64
            runner: macos-13
          - os_name: macos
            arch: arm64
            runner: macos-14
          - os_name: windows
            arch: amd64
            runner: windows-2022
          - os_name: windows
            arch: arm64
            runner: windows-11-arm

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version 2.10.0 --locked

      - name: Install Linux dependencies
        if: startsWith(matrix.runner, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install dependencies
        run: pnpm install

      - name: Build desktop installers
        env:
          ASTRBOT_SOURCE_GIT_URL: ${{ github.event.inputs.source_git_url || env.ASTRBOT_SOURCE_GIT_URL }}
          ASTRBOT_SOURCE_GIT_REF: ${{ github.event.inputs.source_git_ref || env.ASTRBOT_SOURCE_GIT_REF }}
        run: pnpm run build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: astrbot-desktop-tauri-${{ matrix.os_name }}-${{ matrix.arch }}
          if-no-files-found: error
          path: |
            src-tauri/target/release/bundle/dmg/*.dmg
            src-tauri/target/release/bundle/**/*.app.tar.gz
            src-tauri/target/release/bundle/**/*.AppImage
            src-tauri/target/release/bundle/**/*.deb
            src-tauri/target/release/bundle/**/*.rpm
            src-tauri/target/release/bundle/**/*.msi
            src-tauri/target/release/bundle/**/*.exe
